<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:Manager.GUI.ViewModels"
             xmlns:controls="using:Manager.GUI.Controls"
             xmlns:local="using:Manager.GUI.Views"
             xmlns:c="clr-namespace:ColorTextBlock.Avalonia;assembly=ColorTextBlock.Avalonia"
             xmlns:md="clr-namespace:LiveMarkdown.Avalonia;assembly=LiveMarkdown.Avalonia"
             x:Class="Manager.GUI.Views.NginxView"
             x:DataType="vm:NginxViewModel">

    <UserControl.Styles>
        <Style Selector="ListBoxItem">
            <Setter Property="Padding" Value="5,2" />
        </Style>
        <Style Selector="TabItem">
            <Setter Property="FontSize" Value="14" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Padding" Value="10,5" />
        </Style>
    </UserControl.Styles>

    <Grid RowDefinitions="Auto, *">

        <Grid Grid.Row="0" ColumnDefinitions="Auto, *, Auto"
              Margin="10" Background="#2d2d2d">

            <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                <TextBlock Text="Nginx Manager" FontSize="18" VerticalAlignment="Center" Margin="10,0" />
                <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center" Foreground="Orange" />
            </StackPanel>

            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="10">
                <Button Content="ðŸ¤– AI Assistant"
                        Command="{Binding ToggleAiPanelCommand}"
                        Background="#007acc" Foreground="White"
                        Padding="10,8" Margin="0,0,0,0" />

                <Button Content="Save &amp; Reload"
                        Command="{Binding SaveConfigCommand}"
                        Background="#27ae60" Foreground="White"
                        Padding="15,8" Margin="0,0,10,0" />
            </StackPanel>
        </Grid>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="{Binding AiColumnWidth, Mode=TwoWay}"
                                  MinWidth="{Binding AiPanelMinWidth}"
                                  MaxWidth="800" />
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0" BorderBrush="#333" BorderThickness="0,0,1,0">
                <TabControl Margin="0">
                    <TabItem Header="Sites">
                        <ListBox ItemsSource="{Binding Sites}"
                                 SelectedItem="{Binding SelectedSite}"
                                 Background="Transparent">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid ColumnDefinitions="30, *, Auto">
                                        <Ellipse Grid.Column="0" Width="10" Height="10"
                                                 Fill="{Binding IsEnabled, Converter={StaticResource StatusColorConverter}}" />
                                        <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center" />
                                        <Button Grid.Column="2" Content="Toggle"
                                                Command="{Binding $parent[UserControl].((vm:NginxViewModel)DataContext).ToggleSiteCommand}"
                                                CommandParameter="{Binding .}"
                                                FontSize="10" Padding="5,2" />
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </TabItem>

                    <TabItem Header="Snippets">
                        <Grid RowDefinitions="*, Auto">
                            <ListBox Grid.Row="0"
                                     ItemsSource="{Binding Snippets}"
                                     SelectedItem="{Binding SelectedSnippet}"
                                     Background="Transparent">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="#444" BorderThickness="0,0,0,1" Padding="5">
                                            <Grid ColumnDefinitions="*, Auto, Auto, Auto">
                                                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding Name}" FontWeight="Bold" />
                                                    <TextBlock Text="{Binding Description}" FontSize="10" Foreground="#AAA" />
                                                </StackPanel>
                                                <Button Grid.Column="1" Content="â†’" Command="{Binding $parent[UserControl].((vm:NginxViewModel)DataContext).InsertSnippetCommand}" CommandParameter="{Binding .}" Margin="5,0" Background="Transparent" />
                                                <Button Grid.Column="2" Content="âœŽ" Command="{Binding $parent[UserControl].((vm:NginxViewModel)DataContext).EditSnippetCommand}" CommandParameter="{Binding .}" Margin="0,0,5,0" Background="Transparent" />
                                                <Button Grid.Column="3" Content="Ã—" Command="{Binding $parent[UserControl].((vm:NginxViewModel)DataContext).RemoveSnippetCommand}" CommandParameter="{Binding .}" Foreground="Red" Background="Transparent" />
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                            <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="5" Margin="5">
                                <Button Command="{Binding AddSnippetCommand}" Content="Add Snippet" HorizontalAlignment="Stretch" />
                            </StackPanel>
                        </Grid>
                    </TabItem>
                </TabControl>
            </Border>

            <controls:NginxCodeEditor Grid.Column="1"
                                      Name="MainEditor"
                                      Text="{Binding CurrentConfigText}"
                                      SelectedTheme="{Binding CurrentTheme}"
                                      FontFamily="{Binding EditorFontFamily}"
                                      FontSize="{Binding EditorFontSize}"
                                      ExplainCommand="{Binding ExplainSelectionCommand}"
                                      FixCommand="{Binding FixSelectionCommand}" />

            <GridSplitter Grid.Column="2"
                          ResizeDirection="Columns"
                          Width="4"
                          Background="#3e3e42"
                          IsVisible="{Binding IsAiPanelOpen}" />

            <controls:AiAssistantPanel Grid.Column="3"
                                       IsVisible="{Binding IsAiPanelOpen}"
                                       Title="Gemini Assistant"
                                       Messages="{Binding ChatMessages}"
                                       Query="{Binding UserQuery, Mode=TwoWay}"
                                       IsBusy="{Binding IsAiBusy}"
                                       SubmitCommand="{Binding SubmitChatCommand}" />
        </Grid>
    </Grid>
</UserControl>